<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="../lib/openlayerstyle.css">
    <style>
      body {font: 100%/1.3 sans-serif; color: hsla(0,0%,0%,0.65); margin: 0; padding: 0; }
      header h1, footer p { margin: 0; padding: 2rem 1rem; }
      #map { height: calc(100vh - 17rem); width: 100%; }
      a:link, a:visited { color: #0097A7; }
      a:hover, a:focus { color: #00393F; }
      main {
        position: relative;
      }
      .typeahead {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 30rem !important;
        display: block;
        max-width: calc(100% - 3rem);
        z-index: 10;
      }
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">    
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script src="./lib/bootstrap3-typeahead.min.js"></script>

    <title>GeoSearch type-ahead</title>
  </head>
  <body>

    <header>
      <h1>GeoSearch type-ahead</h1>
    </header>
    
    <main>

      <input type="text" class="typeahead form-control pull-right" data-provide="typeahead" autocomplete="off" placeholder="indtast adresse, vej...">

      <div id="map"></div>

    </main>

    <script type="module">

      // Get required modules
      import { 
        Map,
        TileLayer,
        View,
        WMTS,
        optionsFromCapabilities,
        WMTSCapabilities,
        LayerGroup,
        proj4,
        register,
        olProj,
        LayerSwitcher,
        TileWMS,
        ScaleLine,
        Style,
        CircleStyle,
        Fill,
        Stroke,
        VectorLayer,
        VectorSource,
        WKT
      } from '../lib/openlayers.js';  

      // Set Kortforsyningen token, replace with your own token
      var dftoken = '9ca510be3c4eca89b1333cadbaa60c36';

      // Set projection as we are not using the default OpenLayers projections
      // You can define it yourself or you can use the proj4 library as done below
      proj4.defs('EPSG:25832', "+proj=utm +zone=32 +ellps=GRS80 +units=m +no_defs");
      register(proj4);
      const myProjection = olProj.get('EPSG:25832');
      const extent = [120000, 5661139.2, 1378291.2, 6500000];
      myProjection.setExtent(extent);

      // Set the attribution (the copyright statement shown in the lower right corner)
      // We do this as we want the same attributions for all layers
      const myAttributionText = '&copy; <a target="_blank" href="https://dataforsyningen.dk/Vilkaar">Styrelsen for Dataforsyning og Infrastruktur</a>';

      // GeoSearch styles
      // There is a style for the three geometry types
      const gsStyles = {
        'Point': [new Style({
          image: new CircleStyle({
            radius: 7,
            fill: new Fill({
              color: '#CC0000'
            })
          })
        })],
        'LineString': [new Style({
          stroke: new Stroke({
            color: '#CC0000',
            width: 2
          })
        })],    
        'Polygon': [new Style({
          stroke: new Stroke({
            color: '#CC0000',
            width: 2
          })
        })]
      };

      // Function to select correct style by looking at the geometry type of the feature
      const styleFunction = function(feature) {
        return gsStyles[feature.getGeometry().getType()];
      };

      // GeoSearch vector and layer - the geoetries are shown in red
      const gsVector = new VectorSource({});
      const gsLayer = new VectorLayer({
          source: gsVector,
          style: styleFunction
      });

      // Define view
      const myView = new View({
        center: [654500, 6176450], // start center position
        zoom: 9, // start zoom level
        projection: myProjection // use our custom projection defined earlier
      });

      // Define layer groups
      const baseMapLayerGroup = new LayerGroup({
        title: 'Baggrundskort'
      })

      // Initialize the map
      const map = new Map({
        layers: [
          baseMapLayerGroup,
          gsLayer
        ],
        target: 'map',
        view: myView
      });

      // Setup WMTS and parser
      const WMTSparser = new WMTSCapabilities();

      // Fetches 'topo_skaermkort' capabilites and adds layer to map
      const skaermkortCapabilitesUrl = 'https://api.dataforsyningen.dk/topo_skaermkort_wmts_DAF?service=WMTS&request=GetCapabilities&token=' + dftoken
      fetch(skaermkortCapabilitesUrl)
      .then(function (response) {
        return response.text();
      })
      .then(function (text) {
        const result = WMTSparser.read(text);
        let options = optionsFromCapabilities(result, {
          layer: 'topo_skaermkort',
          matrixSet: 'View1',
        });
        // Set attributions
        options.attributions = myAttributionText;
        // Create layer from source
        const skaermkortLayer = new TileLayer({
          title: 'Skærmkort',
          type: 'base',
          opacity: 1,
          source: new WMTS(options)
        })
        // Add layer to map
        baseMapLayerGroup.getLayers().push(skaermkortLayer)
      });

      // Fetches 'orto_foraar' capabilites and adds layer to map
      const ortoCapabilitesUrl = 'https://api.dataforsyningen.dk/orto_foraar_wmts_DAF?service=WMTS&request=GetCapabilities&token=' + dftoken
      fetch(ortoCapabilitesUrl)
      .then(function (response) {
        return response.text();
      })
      .then(function (text) {
        const result = WMTSparser.read(text);
        let options = optionsFromCapabilities(result, {
          layer: 'orto_foraar_wmts',
          matrixSet: 'KortforsyningTilingDK',
        });
        // Set attributions
        options.attributions = myAttributionText;
        // Create layer from source
        const ortoLayer = new TileLayer({
          title: 'Ortofoto',
          type: 'base',
          visible: false,
          opacity: 1,
          source: new WMTS(options)
        })
        // Add layer to map
        baseMapLayerGroup.getLayers().push(ortoLayer)
      });

      // Add additional controls to map
      const layerSwitcher = new LayerSwitcher({
        reverse: true,
        groupSelectStyle: 'group'
      });
      map.addControl(layerSwitcher); // add a layer switcher
      map.addControl(new ScaleLine()); // add a scale line

      // Make a typeahead of the input search field using Bootstrap 3 Typeahead
      $('input.typeahead').typeahead({
        displayText:  function (item){
          return item.presentationString; // this is the attribute of the JSON response to show in the dropdown
        },
        source:  function (query, process) {
          return $.get("https://services.kortforsyningen.dk/Geosearch", { 
            search: query,
            resources: "adresser", // the resource to search within - check valid resources on https://kortforsyningen.dk/indhold/geonoegler-geosearch 
            token: dftoken
          }, 
          function (response) { // This method is being called when data was received from GeoSearch
            if(response.data) {
              return process(response.data);
            }
          });
        },
        afterSelect: function(item) { 
          // when an item in the dropdown was selected try to show the geometry of the item
          if(item.geometryWkt) {
            var format = new WKT();
            var gsFeature = format.readFeature(item.geometryWkt, {
              dataProjection: 'EPSG:25832',
              featureProjection: 'EPSG:25832'
            });
            // add geosearch geometry to map
            gsVector.clear(); // remove any previous geosearch geometry
            gsVector.addFeature(gsFeature); // add new geosearch geometry
            map.getView().fit(gsVector.getExtent()); // zoom to geosearch geometry
          }
        }
      });

    </script>

    <footer>
      <p>© 2023 Styrelsen for Dataforsyning og Infrastruktur</p>
    </footer>

  </body>
</html>
